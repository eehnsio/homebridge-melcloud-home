<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MELCloud Home - Setup</title>
</head>
<body>
    <div class="container-fluid p-4">
        <div id="app">
            <h3 class="mb-3">MELCloud Home - Authentication Setup</h3>
            <p class="text-muted mb-4">
                Enter your MELCloud credentials to get your authentication token. Settings are saved automatically.
            </p>

            <!-- Step 1: Get Token -->
            <div class="card">
                <div class="card-header">
                    Step 1: Get Your Token
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="email-input" class="form-label">MELCloud Email</label>
                        <input
                            type="email"
                            class="form-control"
                            id="email-input"
                            placeholder="your.email@example.com"
                        >
                    </div>
                    <div class="mb-3">
                        <label for="password-input" class="form-label">Password</label>
                        <input
                            type="password"
                            class="form-control"
                            id="password-input"
                            placeholder="Your MELCloud password"
                        >
                    </div>
                    <button type="button" id="direct-login-button" class="btn btn-success w-100 mb-2">
                        Login and Get Token
                    </button>
                    <div id="direct-login-result"></div>
                    <small class="text-muted d-block mt-2">
                        Your credentials are sent directly to MELCloud's servers and are not stored.
                    </small>
                </div>
            </div>

            <!-- Step 2: Save Token -->
            <div class="card">
                <div class="card-header">
                    Step 2: Save Authentication Token
                </div>
                <div class="card-body">
                    <label for="token-input" class="form-label">Refresh Token</label>
                    <textarea
                        class="form-control font-monospace mb-3"
                        id="token-input"
                        rows="3"
                        placeholder="Token will appear here after login, or paste manually..."
                    ></textarea>
                    <button type="button" id="save-token-button" class="btn btn-primary w-100">
                        Save Token
                    </button>
                    <div id="save-result"></div>
                </div>
            </div>

            <!-- Step 3: Plugin Configuration -->
            <div class="card">
                <div class="card-header">
                    Step 3: Plugin Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="refresh-interval" class="form-label">
                            Refresh Interval (seconds)
                        </label>
                        <input
                            type="number"
                            class="form-control"
                            id="refresh-interval"
                            min="10"
                            max="3600"
                            value="30"
                        >
                        <small class="text-muted">
                            How often to check MELCloud for updates. Default: 30 seconds.
                        </small>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="debug-mode"
                        >
                        <label class="form-check-label" for="debug-mode">
                            Debug Mode
                        </label>
                        <div>
                            <small class="text-muted">
                                Enable detailed logging for troubleshooting
                            </small>
                        </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="expose-temperature-sensor"
                            checked
                        >
                        <label class="form-check-label" for="expose-temperature-sensor">
                            Expose Temperature Sensor
                        </label>
                        <div>
                            <small class="text-muted">
                                Add a separate temperature sensor for each AC unit
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="fan-speed-buttons" class="form-label">
                            Fan Speed Buttons
                        </label>
                        <select class="form-select" id="fan-speed-buttons">
                            <option value="none">None</option>
                            <option value="simple">Simple (Auto, Quiet, Max)</option>
                            <option value="all">All speeds (Auto, 1-5)</option>
                        </select>
                        <small class="text-muted">
                            Create separate switch buttons for fan speed control with clear labels
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="vane-control" class="form-label">
                            Vane Control
                        </label>
                        <select class="form-select" id="vane-control">
                            <option value="none">None</option>
                            <option value="buttons">Buttons (Auto, Swing)</option>
                        </select>
                        <small class="text-muted">
                            Control vane/swing position. Buttons are OFF when AC is OFF.
                        </small>
                    </div>

                    <div class="alert alert-warning">
                        <strong>Note:</strong> Changing button settings will remove/add accessories. You may need to re-assign rooms in the Home app after restart.
                    </div>

                    <div class="alert alert-info">
                        <strong>Note:</strong> Settings are saved automatically. Restart Homebridge for changes to take effect.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        window.addEventListener('load', async () => {
            console.log('[MELCloudHome UI] Ready');

            // Load current settings
            await loadSettings();

            // Step 1: Direct Login event listener
            document.getElementById('direct-login-button').addEventListener('click', async () => {
                const button = document.getElementById('direct-login-button');
                const resultDiv = document.getElementById('direct-login-result');
                const email = document.getElementById('email-input').value.trim();
                const password = document.getElementById('password-input').value.trim();

                if (!email || !password) {
                    resultDiv.innerHTML = '<div class="alert alert-danger">Please enter both email and password</div>';
                    return;
                }

                button.disabled = true;
                button.innerHTML = 'Logging in...';
                resultDiv.innerHTML = '<div class="alert alert-info">Connecting to MELCloud...</div>';

                try {
                    const response = await window.homebridge.request('/login-with-credentials', {
                        email,
                        password
                    });

                    if (response.success && response.refreshToken) {
                        // Auto-fill the token in Step 2
                        document.getElementById('token-input').value = response.refreshToken;
                        resultDiv.innerHTML = '<div class="alert alert-success">✓ Login successful! Token obtained. See Step 2 below.</div>';
                        // Clear password field for security
                        document.getElementById('password-input').value = '';
                        // Scroll to Step 2
                        document.getElementById('token-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        throw new Error(response.error || 'Login failed');
                    }
                } catch (error) {
                    console.error('[UI] Direct login error:', error);
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger';
                    const strong = document.createElement('strong');
                    strong.textContent = 'Error: ';
                    errorAlert.appendChild(strong);
                    errorAlert.appendChild(document.createTextNode(error.message));
                    errorAlert.appendChild(document.createElement('br'));
                    const small = document.createElement('small');
                    small.textContent = 'Please check your email and password.';
                    errorAlert.appendChild(small);
                    resultDiv.innerHTML = '';
                    resultDiv.appendChild(errorAlert);
                }

                button.disabled = false;
                button.innerHTML = 'Login and Get Token';
            });

            // Step 2: Save token
            document.getElementById('save-token-button').addEventListener('click', async () => {
                const button = document.getElementById('save-token-button');
                const resultDiv = document.getElementById('save-result');
                const token = document.getElementById('token-input').value.trim();

                if (!token) {
                    resultDiv.innerHTML = '<div class="alert alert-danger">Please enter a token</div>';
                    return;
                }

                button.disabled = true;
                button.innerHTML = 'Saving...';
                resultDiv.innerHTML = '<div class="alert alert-info">Saving to config...</div>';

                try {
                    // Get current plugin config
                    const pluginConfig = await window.homebridge.getPluginConfig();

                    // Create or update platform config
                    const platformConfig = pluginConfig && pluginConfig.length > 0
                        ? { ...pluginConfig[0], refreshToken: token }
                        : {
                            platform: 'MELCloudHome',
                            name: 'MELCloud Home',
                            refreshToken: token,
                            refreshInterval: 30,
                            debug: false,
                            exposeTemperatureSensor: true,
                            fanSpeedButtons: 'none',
                            vaneControl: 'none'
                        };

                    // Update and save using Homebridge client-side API
                    await window.homebridge.updatePluginConfig([platformConfig]);
                    await window.homebridge.savePluginConfig();

                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✓ Saved!</strong><br>
                            Token saved to config.json<br><br>
                            <strong>Next:</strong> Restart Homebridge for changes to take effect
                        </div>
                    `;
                    document.getElementById('token-input').value = '';

                } catch (error) {
                    console.error('[UI] Save error:', error);
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger';
                    const strong = document.createElement('strong');
                    strong.textContent = 'Error: ';
                    errorAlert.appendChild(strong);
                    errorAlert.appendChild(document.createTextNode(error.message));
                    resultDiv.innerHTML = '';
                    resultDiv.appendChild(errorAlert);
                }

                button.disabled = false;
                button.innerHTML = 'Save Token';
            });

            // Auto-save settings when changed
            document.getElementById('refresh-interval').addEventListener('change', saveSettings);
            document.getElementById('debug-mode').addEventListener('change', saveSettings);
            document.getElementById('expose-temperature-sensor').addEventListener('change', saveSettings);
            document.getElementById('fan-speed-buttons').addEventListener('change', saveSettings);
            document.getElementById('vane-control').addEventListener('change', saveSettings);
        });

        // Auto-save settings
        async function saveSettings() {
            try {
                const pluginConfig = await window.homebridge.getPluginConfig();
                const config = (pluginConfig && pluginConfig.length > 0) ? pluginConfig[0] : {
                    platform: 'MELCloudHome',
                    name: 'MELCloud Home'
                };

                // Update settings while preserving refreshToken
                const rawInterval = parseInt(document.getElementById('refresh-interval').value);
                config.refreshInterval = Math.max(10, Math.min(3600, isNaN(rawInterval) ? 30 : rawInterval));
                config.debug = document.getElementById('debug-mode').checked;
                config.exposeTemperatureSensor = document.getElementById('expose-temperature-sensor').checked;
                config.fanSpeedButtons = document.getElementById('fan-speed-buttons').value;
                config.vaneControl = document.getElementById('vane-control').value;

                // Remove old deprecated options if they exist
                delete config.exposeFanSpeedAccessory;
                delete config.exposeSwingAccessory;
                delete config.exposeSwingMode;
                delete config.swingMode;
                delete config.vaneButtons;

                await window.homebridge.updatePluginConfig([config]);
                await window.homebridge.savePluginConfig();
                console.log('[UI] Settings saved:', config);
            } catch (error) {
                console.error('[UI] Failed to save settings:', error);
            }
        }

        // Load current settings
        async function loadSettings() {
            try {
                const pluginConfig = await window.homebridge.getPluginConfig();
                if (pluginConfig && pluginConfig.length > 0) {
                    const config = pluginConfig[0];
                    document.getElementById('refresh-interval').value = config.refreshInterval || 30;
                    document.getElementById('debug-mode').checked = config.debug || false;
                    document.getElementById('expose-temperature-sensor').checked = config.exposeTemperatureSensor !== false; // Default true
                    document.getElementById('fan-speed-buttons').value = config.fanSpeedButtons || 'none';
                    // Support legacy config migration: vaneButtons "simple" -> vaneControl "buttons"
                    let vaneControl = config.vaneControl || 'none';
                    if (config.vaneButtons === 'simple') vaneControl = 'buttons';
                    document.getElementById('vane-control').value = vaneControl;
                    console.log('[UI] Settings loaded:', config);
                }
            } catch (error) {
                console.error('[UI] Failed to load settings:', error);
            }
        }
    </script>
</body>
</html>
