<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MELCloud Home - Setup</title>
</head>
<body>
    <div class="container-fluid p-4">
        <div id="app">
            <h3 class="mb-4">MELCloud Home - Setup</h3>

            <!-- Step 1: Get Token -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Step 1: Get Your Token</strong>
                </div>
                <div class="card-body">
                    <button type="button" id="login-browser-button" class="btn btn-primary w-100 mb-2">
                        Open MELCloud Login
                    </button>
                    <small class="text-muted d-block mb-2">
                        This will open MELCloud login. After logging in, the browser will show an error - this is normal!
                    </small>

                    <div id="oauth-instructions" style="display: none;" class="alert alert-info mt-3">
                        <strong>Copy the callback URL:</strong><br>
                        1. Press F12 to open browser console<br>
                        2. Look for red error: <code>Failed to launch 'melcloudhome://?code=...'</code><br>
                        3. Copy the full <code>melcloudhome://</code> URL
                    </div>

                    <div id="callback-section" style="display: none;" class="mt-3">
                        <input
                            type="text"
                            class="form-control font-monospace mb-2"
                            id="callback-url"
                            placeholder="Paste melcloudhome://... URL here"
                        >
                        <button type="button" id="process-callback-button" class="btn btn-success w-100">
                            Get Token from URL
                        </button>
                    </div>
                    <div id="oauth-result" class="mt-3"></div>
                </div>
            </div>

            <!-- Step 2: Save Token -->
            <div class="card">
                <div class="card-header">
                    <strong>Step 2: Save Token</strong>
                </div>
                <div class="card-body">
                    <textarea
                        class="form-control font-monospace mb-2"
                        id="token-input"
                        rows="3"
                        placeholder="Paste your refresh token here..."
                    ></textarea>
                    <button type="button" id="save-token-button" class="btn btn-primary btn-lg w-100">
                        Save Token to Config
                    </button>
                    <div id="save-result" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let homebridge;
        let oauthState, oauthVerifier;

        // Step 1: Open MELCloud Login
        document.getElementById('login-browser-button').addEventListener('click', async () => {
            // Generate OAuth params
            oauthState = generateRandomString(32);
            oauthVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(oauthVerifier);

            // Build OAuth URL
            const authUrl = new URL('https://auth.melcloudhome.com/connect/authorize');
            authUrl.searchParams.set('client_id', 'homemobile');
            authUrl.searchParams.set('redirect_uri', 'melcloudhome://');
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('scope', 'openid profile email offline_access IdentityServerApi');
            authUrl.searchParams.set('state', oauthState);
            authUrl.searchParams.set('code_challenge', codeChallenge);
            authUrl.searchParams.set('code_challenge_method', 'S256');
            authUrl.searchParams.set('prompt', 'login');

            // Open login window
            window.open(authUrl.toString(), 'melcloud_' + Date.now(), 'width=600,height=800');

            // Show instructions
            document.getElementById('oauth-instructions').style.display = 'block';
            document.getElementById('callback-section').style.display = 'block';
        });

        // Process callback URL
        document.getElementById('process-callback-button').addEventListener('click', async () => {
            const callbackUrl = document.getElementById('callback-url').value.trim();
            const resultDiv = document.getElementById('oauth-result');

            if (!callbackUrl || !callbackUrl.startsWith('melcloudhome://')) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter a valid melcloudhome:// URL</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="alert alert-info">Getting token...</div>';

            try {
                const response = await homebridge.request('/process-oauth-callback', {
                    callbackUrl,
                    verifier: oauthVerifier,
                    expectedState: oauthState
                });

                if (response.success && response.refreshToken) {
                    // Auto-fill the token in Step 2
                    document.getElementById('token-input').value = response.refreshToken;
                    resultDiv.innerHTML = '<div class="alert alert-success">✓ Token obtained! See Step 2 below.</div>';
                    // Scroll to Step 2
                    document.getElementById('token-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    throw new Error(response.error || 'Failed to get token');
                }
            } catch (error) {
                console.error('[UI] OAuth error:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            }
        });

        // Step 2: Save token
        document.getElementById('save-token-button').addEventListener('click', async () => {
            const button = document.getElementById('save-token-button');
            const resultDiv = document.getElementById('save-result');
            const token = document.getElementById('token-input').value.trim();

            if (!token) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter a token</div>';
                return;
            }

            button.disabled = true;
            button.innerHTML = 'Saving...';
            resultDiv.innerHTML = '<div class="alert alert-info">Saving to config...</div>';

            try {
                console.log('[UI] Saving token, length:', token.length);

                // Get current plugin config
                const pluginConfig = await homebridge.getPluginConfig();
                console.log('[UI] Current config:', pluginConfig);

                // Create or update platform config
                const platformConfig = pluginConfig && pluginConfig.length > 0
                    ? { ...pluginConfig[0], refreshToken: token }
                    : {
                        platform: 'MELCloudHome',
                        name: 'MELCloud Home',
                        refreshToken: token,
                        refreshInterval: 90,
                        debug: false
                    };

                console.log('[UI] Updating with config:', platformConfig);

                // Update and save using Homebridge client-side API
                await homebridge.updatePluginConfig([platformConfig]);
                await homebridge.savePluginConfig();

                console.log('[UI] ✓ Config saved successfully');

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>✓ Saved!</strong><br>
                        Token saved to config.json<br><br>
                        <strong>Next:</strong> Manually restart Homebridge
                    </div>
                `;
                document.getElementById('token-input').value = '';

            } catch (error) {
                console.error('[UI] Save error:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            }

            button.disabled = false;
            button.innerHTML = 'Save Token to Config';
        });

        // Helper functions
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            const randomValues = new Uint8Array(length);
            crypto.getRandomValues(randomValues);
            return Array.from(randomValues).map(x => charset[x % charset.length]).join('');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            const base64 = btoa(String.fromCharCode(...new Uint8Array(hash)));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Initialize
        window.addEventListener('load', () => {
            homebridge = window.homebridge;
            console.log('[MELCloudHome UI] Ready');
        });
    </script>
</body>
</html>
